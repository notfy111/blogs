<!DOCTYPE html>
<html lang="en-us">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="robots" content="noodp" />
        <meta http-equiv="X-UA-Compatible" content="IE=edge, chrome=1">
        <title>Interpretable CNN: Insect Classification - Evers Feng Blog</title><meta name="Description" content=""><meta property="og:title" content="Interpretable CNN: Insect Classification" />
<meta property="og:description" content="Background Convolutional Neural Network has made ground-breaking achivements in the Computer Domain. Nowadays, it has been widely on different deep learning tasks including object classification, search engines, and face recognition. However, given its complex architecture and high abstraction level, CNN models have remained relatively un-explainable and are bestowed the name of &ldquo;black box model.&rdquo; Researchers have been trying to find frameworks and tools that can help debunk the myths of CNN and make it more interpretable." />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://evers-feng.com/blogs/posts/insects_classification/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2021-11-14T15:51:01-05:00" />
<meta property="article:modified_time" content="2021-11-14T15:51:01-05:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Interpretable CNN: Insect Classification"/>
<meta name="twitter:description" content="Background Convolutional Neural Network has made ground-breaking achivements in the Computer Domain. Nowadays, it has been widely on different deep learning tasks including object classification, search engines, and face recognition. However, given its complex architecture and high abstraction level, CNN models have remained relatively un-explainable and are bestowed the name of &ldquo;black box model.&rdquo; Researchers have been trying to find frameworks and tools that can help debunk the myths of CNN and make it more interpretable."/>
<meta name="application-name" content="Evers Feng Blog">
<meta name="apple-mobile-web-app-title" content="Evers Feng Blog"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="http://evers-feng.com/blogs/posts/insects_classification/" /><link rel="prev" href="http://evers-feng.com/blogs/posts/graduate-school-dashboard/" /><link rel="stylesheet" href="/blogs/lib/normalize/normalize.min.css"><link rel="stylesheet" href="/blogs/css/style.min.css"><link rel="stylesheet" href="/blogs/lib/fontawesome-free/all.min.css"><link rel="stylesheet" href="/blogs/lib/animate/animate.min.css"><script type="application/ld+json">
    {
        "@context": "http://schema.org",
        "@type": "BlogPosting",
        "headline": "Interpretable CNN: Insect Classification",
        "inLanguage": "en-us",
        "mainEntityOfPage": {
            "@type": "WebPage",
            "@id": "http:\/\/evers-feng.com\/blogs\/posts\/insects_classification\/"
        },"genre": "posts","wordcount":  532 ,
        "url": "http:\/\/evers-feng.com\/blogs\/posts\/insects_classification\/","datePublished": "2021-11-14T15:51:01-05:00","dateModified": "2021-11-14T15:51:01-05:00","publisher": {
            "@type": "Organization",
            "name": "Evers"},"author": {
                "@type": "Person",
                "name": "Evers"
            },"description": ""
    }
    </script></head>
    <body header-desktop="" header-mobile=""><script type="text/javascript">(window.localStorage && localStorage.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : '' === 'dark')) && document.body.setAttribute('theme', 'dark');</script>

        <div id="mask"></div><div class="wrapper"><header class="desktop" id="header-desktop">
    <div class="header-wrapper">
        <div class="header-title">
            <a href="/blogs/" title="Evers Feng Blog">Evers Feng Blog</a>
        </div>
        <div class="menu">
            <div class="menu-inner"><a class="menu-item" href="/blogs/blogs/posts/"> Posts </a><a class="menu-item" href="/blogs/blogs/tags/"> Tags </a><a class="menu-item" href="/blogs/blogs/categories/"> Categories </a><span class="menu-item delimiter"></span><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                    <i class="fas fa-adjust fa-fw"></i>
                </a>
            </div>
        </div>
    </div>
</header><header class="mobile" id="header-mobile">
    <div class="header-container">
        <div class="header-wrapper">
            <div class="header-title">
                <a href="/blogs/" title="Evers Feng Blog">Evers Feng Blog</a>
            </div>
            <div class="menu-toggle" id="menu-toggle-mobile">
                <span></span><span></span><span></span>
            </div>
        </div>
        <div class="menu" id="menu-mobile"><a class="menu-item" href="/blogs/blogs/posts/" title="">Posts</a><a class="menu-item" href="/blogs/blogs/tags/" title="">Tags</a><a class="menu-item" href="/blogs/blogs/categories/" title="">Categories</a><a href="javascript:void(0);" class="menu-item theme-switch" title="Switch Theme">
                <i class="fas fa-adjust fa-fw"></i>
            </a></div>
    </div>
</header>
<div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
</div>
<div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
</div>
<main class="main">
                <div class="container"><div class="toc" id="toc-auto">
            <h2 class="toc-title">Contents</h2>
            <div class="toc-content" id="toc-content-auto"></div>
        </div><article class="page single"><h1 class="single-title animated flipInX">Interpretable CNN: Insect Classification</h1><div class="post-meta">
            <div class="post-meta-line"><span class="post-author"><a href="https://evers-feng.com" title="Author" target="_blank" rel="noopener noreffer author" class="author"><i class="fas fa-user-circle fa-fw"></i>Evers</a></span></div>
            <div class="post-meta-line"><i class="far fa-calendar-alt fa-fw"></i>&nbsp;<time datetime="2021-11-14">2021-11-14</time>&nbsp;<i class="fas fa-pencil-alt fa-fw"></i>&nbsp;532 words&nbsp;
                <i class="far fa-clock fa-fw"></i>&nbsp;3 minutes&nbsp;</div>
        </div><div class="details toc" id="toc-static"  kept="">
                <div class="details-summary toc-title">
                    <span>Contents</span>
                    <span><i class="details-icon fas fa-angle-right"></i></span>
                </div>
                <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#background">Background</a></li>
    <li><a href="#data">Data</a></li>
    <li><a href="#model">Model</a></li>
    <li><a href="#shap-interpretation">SHAP Interpretation</a></li>
  </ul>
</nav></div>
            </div><div class="content" id="content"><h2 id="background">Background</h2>
<p>Convolutional Neural Network has made ground-breaking achivements in the Computer Domain. Nowadays, it has been widely on different deep learning tasks including object classification, search engines, and face recognition. However, given its complex architecture and high abstraction level, CNN models have remained relatively un-explainable and are bestowed the name of &ldquo;black box model.&rdquo;
Researchers have been trying to find frameworks and tools that can help debunk the myths of CNN and make it more interpretable. <a href="https://github.com/slundberg/shap" target="_blank" rel="noopener noreffer">SHAP</a> is one of the most robust and easy-to-use tools that visualize and make sense of the model prediction. In this analysis, we are going to use a Tensorflow CNN model on insect images to create a classification model that distinguishes beetles, cockroaches, and dragonflies. Then we are going to use SHAP to interprete the model and understand how does the model made predictions.</p>
<h2 id="data">Data</h2>
<p>For this task, we are going to train our model on 1019 photos that is balanced across three different insects: beetles, cockroaches, and dragonflies. After training, we are going to examine model performance on 180 photos also balanced across the three different classes.
When creating the data, therea are 4 pre-processing steps:</p>
<ul>
<li>convert photo folder index into numerical label</li>
<li>read in images in grey scale</li>
<li>standardize each pixel value by 255</li>
<li>scale each picture to be 200 x 200 dimension.</li>
</ul>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="p">{</span>
<span class="k">for</span> <span class="n">category</span> <span class="ow">in</span> <span class="n">categories</span><span class="p">:</span>
    <span class="c1"># path to folder that contains the picture</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">train_directory</span><span class="p">,</span> <span class="n">category</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">img</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>  <span class="c1"># Iterate over every image</span>
        <span class="n">img_array</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span><span class="n">img</span><span class="p">)</span> <span class="p">,</span><span class="n">cv2</span><span class="o">.</span><span class="n">IMREAD_GRAYSCALE</span><span class="p">)</span> <span class="c1"># Convert to array</span>
        <span class="n">label</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">category</span><span class="p">)</span> <span class="c1"># Give label: beetles=0, cockroach=1, dragonflies = 2</span>
        <span class="n">resized_img</span> <span class="o">=</span> <span class="n">cv2</span><span class="o">.</span><span class="n">resize</span><span class="p">(</span><span class="n">img_array</span><span class="p">,</span> <span class="p">(</span><span class="n">imag_size</span><span class="p">,</span> <span class="n">imag_size</span><span class="p">))</span>
        <span class="n">standardized</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">resized_img</span><span class="p">,</span> <span class="n">standardize</span><span class="p">)</span>
        <span class="n">training_data</span><span class="o">.</span><span class="n">append</span><span class="p">([(</span><span class="n">standardized</span><span class="p">),</span> <span class="n">label</span><span class="p">])</span>
<span class="p">}</span>
</code></pre></div><h2 id="model">Model</h2>
<p>In this analysis, we built a CNN model using Tensorflow Keras that has two convolutional layers, one max pooling layer, and two fully-connected layers. Essentially, this model takes in 200 x 200 x 1 matrix, and sequentially applies layers on the input and use a softmax function to assign a probability of the photo belonging to each class.</p>
<div class="highlight"><pre tabindex="0" class="chroma"><code class="language-python" data-lang="python"><span class="p">{</span>
<span class="n">shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">200</span><span class="p">,</span><span class="mi">200</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">Sequential</span><span class="p">()</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span>
                 <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">,</span>
                 <span class="n">input_shape</span><span class="o">=</span><span class="n">shape</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Conv2D</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">MaxPooling2D</span><span class="p">(</span><span class="n">pool_size</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">)))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Flatten</span><span class="p">())</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="mi">128</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;relu&#39;</span><span class="p">))</span>
<span class="n">model</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Dense</span><span class="p">(</span><span class="n">num_classes</span><span class="p">,</span> <span class="n">activation</span><span class="o">=</span><span class="s1">&#39;softmax&#39;</span><span class="p">))</span>
<span class="p">}</span>
</code></pre></div><p>This relatively simple architecture after 3 epochs of training is able to give satisfactory predictions. The evaluation results show that the model has accuracy, precision, recall all close to 0.98, with F1 score of 0.978.</p>
<h2 id="shap-interpretation">SHAP Interpretation</h2>
<p>Now we are able to see all the trained parameters, prediction results, and different types of evaluation metrics. But how did the model reach the decision that it made? What are the criteria for predicting a picture as bettles instead of dragon flies?
<img
        class="lazyload"
        src="/blogs/svg/loading.min.svg"
        data-src="../../images/shap.jpeg"
        data-srcset="../../images/shap.jpeg, ../../images/shap.jpeg 1.5x, ../../images/shap.jpeg 2x"
        data-sizes="auto"
        alt="../../images/shap.jpeg"
        title="../../images/shap.jpeg" />
What SHAP algorithm does is to use a game theoretic approach to explain the output of any machine learning model. Specifically, red pixels represent positive SHAP values that increase the probability of the class, while blue pixels represent negative SHAP values the reduce the probability of the class.
In this case, we see that the the upper left graph maps to the positive SHAP values for assigning this graph to class 0, which is beetles. It seems that it captures the the lower tail of the beetle as key defining features.</p>
</div><div class="post-footer" id="post-footer">
    <div class="post-info">
        <div class="post-info-line">
            <div class="post-info-mod">
                <span>Updated on 2021-11-14</span>
            </div>
            <div class="post-info-license"></div>
        </div>
        <div class="post-info-line">
            <div class="post-info-md"></div>
            <div class="post-info-share">
                <span></span>
            </div>
        </div>
    </div>

    <div class="post-info-more">
        <section class="post-tags"></section>
        <section>
            <span><a href="javascript:void(0);" onclick="window.history.back();">Back</a></span>&nbsp;|&nbsp;<span><a href="/blogs/">Home</a></span>
        </section>
    </div>

    <div class="post-nav"><a href="/blogs/posts/graduate-school-dashboard/" class="prev" rel="prev" title="Life After Graduate School - Doctorate Recipient Income Analysis"><i class="fas fa-angle-left fa-fw"></i>Life After Graduate School - Doctorate Recipient Income Analysis</a></div>
</div>
</article></div>
            </main><footer class="footer">
        <div class="footer-container"><div class="footer-line">Powered by <a href="https://gohugo.io/" target="_blank" rel="noopener noreffer" title="Hugo 0.87.0">Hugo</a> | Theme - <a href="https://github.com/dillonzq/LoveIt" target="_blank" rel="noopener noreffer" title="LoveIt 0.2.10"><i class="far fa-kiss-wink-heart fa-fw"></i> LoveIt</a>
                </div><div class="footer-line"><i class="far fa-copyright fa-fw"></i><span itemprop="copyrightYear">2021</span><span class="author" itemprop="copyrightHolder">&nbsp;<a href="https://evers-feng.com" target="_blank">Evers</a></span></div>
        </div>
    </footer></div>

        <div id="fixed-buttons"><a href="#" id="back-to-top" class="fixed-button" title="Back to Top">
                <i class="fas fa-arrow-up fa-fw"></i>
            </a><a href="#" id="view-comments" class="fixed-button" title="View Comments">
                <i class="fas fa-comment fa-fw"></i>
            </a>
        </div><script type="text/javascript" src="/blogs/lib/smooth-scroll/smooth-scroll.min.js"></script><script type="text/javascript" src="/blogs/lib/lazysizes/lazysizes.min.js"></script><script type="text/javascript" src="/blogs/lib/clipboard/clipboard.min.js"></script><script type="text/javascript">window.config={"code":{"copyTitle":"Copy to clipboard","maxShownLines":10},"comment":{}};</script><script type="text/javascript" src="/blogs/js/theme.min.js"></script></body>
</html>
